<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Streak Studio - Refined</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000; 
            color: white; 
            overflow: hidden; 
            user-select: none; 
            margin: 0; 
            touch-action: none;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Bloqueia √≠cones de utilit√°rios de navegadores (como Edge Visual Search) */
        img {
            pointer-events: none;
            -webkit-user-drag: none;
        }
        .draggable-acc img, .character-img {
            pointer-events: none !important;
        }

        @media (min-width: 1024px) {
            body { flex-direction: row; }
            .main-canvas { flex: 1; height: 100vh; position: relative; }
            .sidebar { width: 380px; height: 100vh; border-left: 1px solid rgba(255,255,255,0.1); background: #000; }
        }

        .title-3d {
            font-weight: 900; font-style: italic; text-transform: uppercase; color: #fff; letter-spacing: -1px;
            text-shadow: 0 1px 0 #ccc, 0 2px 0 #c9c9c9, 0 3px 0 #bbb, 0 4px 0 #b9b9b9, 0 5px 0 #aaa, 0 6px 1px rgba(0,0,0,.1), 0 0 5px rgba(0,0,0,.1), 0 1px 3px rgba(0,0,0,.3), 0 3px 5px rgba(0,0,0,.2), 0 5px 10px rgba(0,0,0,.25);
        }

        .character-container { position: relative; width: 100%; height: 50vh; display: flex; justify-content: center; align-items: center; z-index: 10; }
        @media (min-width: 1024px) { .character-container { height: 100vh; } }

        .character-wrapper { position: relative; width: 280px; height: 280px; transition: transform 0.05s ease-out; border: 2px dashed transparent; }
        .character-wrapper.selected { border-color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.05); border-radius: 12px; }
        .character-img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        
        .draggable-acc { position: absolute; z-index: 50; display: none; transform-origin: center center; pointer-events: none; width: 120px; height: 120px; top: 50px; left: 65px; border: 2px dashed transparent; }
        .draggable-acc.active { display: block; }
        .draggable-acc.selected { border-color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.05); border-radius: 8px; pointer-events: auto; }

        .control-btn {
            position: absolute; width: 30px; height: 30px; color: white; border-radius: 50%; display: none;
            align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); 
            cursor: pointer; z-index: 60; border: 2px solid white; pointer-events: auto; transform: scale(1) !important;
        }
        .trash-btn { background: #ff4444; top: -15px; right: -15px; }
        .mirror-btn { background: #3b82f6; top: -15px; left: -15px; }
        .draggable-acc.selected .control-btn { display: flex; }
        
        .sidebar { position: relative; z-index: 100; background: #000; border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        #main-menu { border-bottom: 2px solid rgba(255,255,255,0.05); display: flex; overflow-x: auto; scrollbar-width: none; }
        .tab-btn { padding: 12px 20px; font-weight: 700; font-size: 13px; color: #666; text-align: center; position: relative; white-space: nowrap; cursor: pointer; }
        .tab-btn.active { color: white; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 20%; width: 60%; height: 3px; background: white; border-radius: 10px; }
        
        .submenu { display: flex; gap: 8px; padding: 10px 16px; background: #000; overflow-x: auto; min-height: 48px; }
        .sub-tab-btn { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #fff; padding: 5px 12px; border-radius: 20px; background: #1A1A1A; border: 1px solid transparent; white-space: nowrap; cursor: pointer; }
        .sub-tab-btn.active { background: #333; border-color: #555; }

        .action-group { display: flex; gap: 8px; }
        @media (max-width: 1023px) { .action-group { flex-direction: column; align-items: flex-end; } }

        .action-btn { background: #222; color: white; font-size: 9px; font-weight: 900; padding: 6px 10px; border-radius: 8px; text-transform: uppercase; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); width: 80px; text-align: center; }
        .action-btn:hover { background: #333; }
        
        .content-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px; flex: 1; overflow-y: auto; align-content: start; }
        @media (max-width: 1023px) { .content-grid { grid-template-columns: repeat(3, 1fr); height: 260px; } }

        .item-card-wrapper { display: flex; flex-direction: column; gap: 6px; align-items: center; text-align: center; cursor: pointer; }
        .item-card { background: #FFFFFF; border-radius: 12px; width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; padding: 10px; }
        .item-card-wrapper.selected .item-card { border-color: #3b82f6; border-width: 3px; }
        .item-name { font-size: 10px; font-weight: 800; color: white; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .item-author { font-size: 8px; font-weight: 500; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        
        #streak-input { background: transparent; color: white; border: none; font-weight: bold; width: 100%; text-align: center; outline: none; }
    </style>
</head>
<body onclick="deselectAll(event)">

    <main class="main-canvas" id="canvas-area">
        <header class="p-6 flex justify-between items-start absolute top-0 left-0 w-full z-[100]">
            <h1 class="title-3d text-2xl">Streak Studio</h1>
            <div class="text-right flex flex-col items-end gap-3">
                <div class="flex flex-col items-end">
                    <span id="streak-count" class="text-4xl font-black italic leading-none">3</span>
                    <span class="text-[9px] font-bold uppercase tracking-wider text-gray-400 mt-1">Dias de sequ√™ncia</span>
                </div>
                <div class="action-group">
                    <button class="action-btn" onclick="undo(); event.stopPropagation();">Undo ‚Ü©Ô∏è</button>
                    <button class="action-btn" onclick="redo(); event.stopPropagation();">Redo ‚Ü™Ô∏è</button>
                    <button class="action-btn !bg-red-600" onclick="resetAccPositions(); event.stopPropagation();">Reset üõ†Ô∏è</button>
                </div>
            </div>
        </header>

        <div class="character-container">
            <div class="character-wrapper" id="interaction-zone">
                <img id="char-img" src="fogo_amarelo.png" class="character-img">
            </div>
        </div>
    </main>

    <aside class="sidebar" onclick="event.stopPropagation()">
        <div class="px-5 py-6 flex gap-2 border-b border-white/10">
            <button onclick="increaseStreak()" class="flex-1 bg-white text-black font-black py-4 rounded-xl uppercase italic text-xs hover:bg-gray-200 cursor-pointer">Mandar Foguinho üî•</button>
            <div class="w-14 h-14 flex items-center justify-center rounded-xl bg-[#1A1A1A] text-white font-bold text-lg border border-white/5">
                <input type="number" id="streak-input" value="3" oninput="manualStreakUpdate(this.value)">
            </div>
        </div>
        
        <nav id="main-menu"></nav>
        <div id="sub-menu-container" class="submenu no-scrollbar"></div>
        <div id="grid-content" class="content-grid no-scrollbar"></div>
    </aside>

    <script>
        // Bloqueio de Inspe√ß√£o e Menu de Contexto
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false; // F12
            if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) return false;
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; // Ctrl+U
        };

        const GITHUB_JSON_URL = "https://raw.githubusercontent.com/bytechoficial/steak-studio-data/refs/heads/main/itens.json";

        let streak = 3;
        let activeAccessories = {}; 
        let currentTab = ''; 
        let currentSubTab = '';
        let todosOsItens = [];
        let accStates = {}; 
        let charState = { x: 0, y: 0, s: 1, r: 0, flip: 1 }; 
        let currentPoseImg = null;

        let history = [];
        let historyStep = -1;

        function deselectAll(e) {
            if (e.target.id === 'canvas-area' || e.target.classList.contains('character-container')) {
                document.querySelectorAll('.draggable-acc, .character-wrapper').forEach(el => el.classList.remove('selected'));
                start.selectedTarget = null;
            }
        }

        function saveHistory() {
            const state = JSON.stringify({ activeAccessories, accStates, charState, currentPoseImg });
            if (historyStep < history.length - 1) history = history.slice(0, historyStep + 1);
            history.push(state);
            if (history.length > 50) history.shift(); else historyStep++;
        }

        function undo() { if (historyStep > 0) { historyStep--; applyHistoryState(JSON.parse(history[historyStep])); } }
        function redo() { if (historyStep < history.length - 1) { historyStep++; applyHistoryState(JSON.parse(history[historyStep])); } }

        function applyHistoryState(state) {
            activeAccessories = state.activeAccessories;
            accStates = state.accStates;
            charState = state.charState;
            currentPoseImg = state.currentPoseImg;
            document.querySelectorAll('.draggable-acc').forEach(el => el.classList.remove('active'));
            for (let slot in activeAccessories) {
                if (activeAccessories[slot]) {
                    toggleAcc(slot, activeAccessories[slot], true);
                    const el = document.getElementById(slot + '-container');
                    const s = accStates[slot];
                    if(el) {
                        el.style.transform = `translate(${s.x}px, ${s.y}px) scale(${s.s}) rotate(${s.r}deg)`;
                        el.querySelector('img').style.transform = `scaleX(${s.flip})`;
                    }
                }
            }
            const zone = document.getElementById('interaction-zone');
            zone.style.transform = `translate(${charState.x}px, ${charState.y}px) scale(${charState.s}) rotate(${charState.r}deg)`;
            updateUI(); renderGrid();
        }

        function getStreakInfo() {
            if (streak >= 199) return { color: '#3b82f6', base: 'fogo_azul.png', id: 'azul' };
            if (streak >= 100) return { color: '#a855f7', base: 'fogo_roxo.png', id: 'roxo' };
            if (streak >= 30) return { color: '#f97316', base: 'fogo_laranja.png', id: 'laranja' };
            return { color: '#fde047', base: 'fogo_amarelo.png', id: 'amarelo' };
        }

        function renderTabs() {
            const menu = document.getElementById('main-menu');
            const categorias = [...new Set(todosOsItens.map(i => i.categoria))];
            if (!currentTab) currentTab = categorias[0];
            menu.innerHTML = '';
            categorias.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${currentTab === cat ? 'active' : ''}`;
                btn.innerText = cat.charAt(0).toUpperCase() + cat.slice(1);
                btn.onclick = () => { currentTab = cat; currentSubTab = ''; renderTabs(); renderMenus(); renderGrid(); };
                menu.appendChild(btn);
            });
        }

        function renderMenus() {
            const subMenu = document.getElementById('sub-menu-container');
            if (currentTab === 'pose') { subMenu.style.display = 'none'; return; }
            const itensDaAba = todosOsItens.filter(i => i.categoria === currentTab);
            const subs = [...new Set(itensDaAba.map(i => i.sub))].filter(s => s !== "");
            if (subs.length <= 1) { subMenu.style.display = 'none'; currentSubTab = subs[0] || ""; return; }
            subMenu.style.display = 'flex';
            if (!currentSubTab || !subs.includes(currentSubTab)) currentSubTab = subs[0];
            subMenu.innerHTML = '';
            subs.forEach(s => {
                const btn = document.createElement('button');
                btn.innerText = s.toUpperCase();
                btn.className = `sub-tab-btn ${currentSubTab === s ? 'active' : ''}`;
                btn.onclick = () => { currentSubTab = s; renderMenus(); renderGrid(); };
                subMenu.appendChild(btn);
            });
        }

        function renderGrid() {
            const grid = document.getElementById('grid-content');
            grid.innerHTML = '';
            const info = getStreakInfo();
            const filtered = todosOsItens.filter(i => {
                if (currentTab === 'pose') return i.categoria === 'pose' && i.sub === info.id;
                if (!currentSubTab) return i.categoria === currentTab;
                return i.categoria === currentTab && i.sub === currentSubTab;
            });
            filtered.forEach(item => {
                const slot = item.sub || item.categoria;
                const isSelected = (currentTab === 'pose') ? (currentPoseImg === item.imagem) : (activeAccessories[slot] === item.imagem);
                const wrapper = document.createElement('div');
                wrapper.className = `item-card-wrapper ${isSelected ? 'selected' : ''}`;
                wrapper.onclick = (e) => {
                    e.stopPropagation();
                    if (currentTab === 'pose') currentPoseImg = (currentPoseImg === item.imagem) ? null : item.imagem;
                    else toggleAcc(slot, item.imagem);
                    saveHistory(); updateUI(); renderGrid();
                };
                wrapper.innerHTML = `<div class="item-card"><img src="${item.imagem}" class="w-full h-full object-contain"></div><div class="item-name">${item.nome}</div><div class="item-author">${item.autor || item.author || 'BY TECH'}</div>`;
                grid.appendChild(wrapper);
            });
        }

        function updateUI() {
            const info = getStreakInfo();
            document.getElementById('streak-count').innerText = streak;
            document.getElementById('streak-input').value = streak;
            document.getElementById('streak-count').style.color = info.color;
            document.getElementById('char-img').src = currentPoseImg ? currentPoseImg : info.base;
        }

        function toggleAcc(slot, img, skipHistory = false) {
            let container = document.getElementById(slot + '-container');
            if (!skipHistory && activeAccessories[slot] === img) { removeAcc(slot); } else {
                activeAccessories[slot] = img;
                if (!container) {
                    container = document.createElement('div');
                    container.id = slot + '-container';
                    container.className = 'draggable-acc';
                    container.innerHTML = `<div class="control-btn trash-btn" onclick="removeAcc('${slot}')">üóëÔ∏è</div><div class="control-btn mirror-btn" onclick="mirrorAcc('${slot}')">‚ÜîÔ∏è</div><img src="${img}" class="acc-content-img w-full h-full object-contain">`;
                    document.getElementById('interaction-zone').appendChild(container);
                    if (!accStates[slot]) accStates[slot] = { x: 0, y: 0, s: 1, r: 0, flip: 1 };
                } else { container.querySelector('img').src = img; }
                container.classList.add('active');
            }
        }

        function removeAcc(slot) {
            activeAccessories[slot] = null;
            const container = document.getElementById(slot + '-container');
            if(container) container.classList.remove('active', 'selected');
            saveHistory(); updateUI(); renderGrid();
        }

        function mirrorAcc(slot) {
            const state = accStates[slot];
            state.flip *= -1; 
            document.getElementById(slot + '-container').querySelector('.acc-content-img').style.transform = `scaleX(${state.flip})`;
            saveHistory();
        }

        let start = { x: 0, y: 0, dist: 0, angle: 0, isMoving: false, selectedTarget: null };
        const zone = document.getElementById('interaction-zone');

        zone.addEventListener('wheel', (e) => {
            if (!start.selectedTarget) return;
            e.preventDefault();
            let state = (start.selectedTarget === 'char-body') ? charState : accStates[start.selectedTarget];
            let element = (start.selectedTarget === 'char-body') ? zone : document.getElementById(start.selectedTarget + '-container');
            if (e.shiftKey) { state.r += (e.deltaY + e.deltaX) * 0.5; } else { state.s *= (e.deltaY > 0 ? 0.95 : 1.05); }
            element.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.s}) rotate(${state.r}deg)`;
        }, { passive: false });

        zone.addEventListener('touchstart', handleStart, { passive: false });
        zone.addEventListener('mousedown', handleStart);

        function handleStart(e) {
            if (e.target.closest('.control-btn')) return;
            e.stopPropagation();
            const isTouch = e.type === 'touchstart';
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            let targetId = null; let minDist = 80; 
            document.querySelectorAll('.draggable-acc, .character-wrapper').forEach(el => el.classList.remove('selected'));
            for (let id in activeAccessories) {
                if (!activeAccessories[id]) continue;
                const el = document.getElementById(id + '-container');
                if (!el || !el.classList.contains('active')) continue;
                const rect = el.getBoundingClientRect();
                const d = Math.hypot(clientX - (rect.left + rect.width/2), clientY - (rect.top + rect.height/2));
                if (d < minDist) { minDist = d; targetId = id; }
            }
            if (!targetId) targetId = 'char-body';
            start.selectedTarget = targetId; start.isMoving = true;
            const el = targetId === 'char-body' ? zone : document.getElementById(targetId + '-container');
            el.classList.add('selected');
            start.x = clientX; start.y = clientY;
            if (isTouch && e.touches.length === 2) {
                start.dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                start.angle = Math.atan2(e.touches[1].clientY - e.touches[0].clientY, e.touches[1].clientX - e.touches[0].clientX);
            }
        }

        window.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('mousemove', handleMove);

        function handleMove(e) {
            if (!start.isMoving) return;
            const isTouch = e.type === 'touchmove';
            let state = (start.selectedTarget === 'char-body') ? charState : accStates[start.selectedTarget];
            let element = (start.selectedTarget === 'char-body') ? zone : document.getElementById(start.selectedTarget + '-container');
            if (isTouch && e.touches.length === 2) {
                e.preventDefault();
                const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                const a = Math.atan2(e.touches[1].clientY - e.touches[0].clientY, e.touches[1].clientX - e.touches[0].clientX);
                state.s *= (d / start.dist); state.r += (a - start.angle) * (180 / Math.PI);
                start.dist = d; start.angle = a;
            } else {
                const clientX = isTouch ? e.touches[0].clientX : e.clientX;
                const clientY = isTouch ? e.touches[0].clientY : e.clientY;
                state.x += (clientX - start.x); state.y += (clientY - start.y);
                start.x = clientX; start.y = clientY;
            }
            element.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.s}) rotate(${state.r}deg)`;
        }

        window.addEventListener('mouseup', () => { if(start.isMoving) saveHistory(); start.isMoving = false; });
        window.addEventListener('touchend', () => { if(start.isMoving) saveHistory(); start.isMoving = false; });

        async function loadGitHubData() {
            try {
                const response = await fetch(GITHUB_JSON_URL + "?t=" + new Date().getTime());
                todosOsItens = await response.json();
                renderTabs(); renderMenus(); renderGrid(); saveHistory();
            } catch (e) { console.error("Erro ao carregar"); }
        }

        function resetAccPositions() {
            charState = { x: 0, y: 0, s: 1, r: 0, flip: 1 };
            zone.style.transform = `translate(0,0) scale(1) rotate(0)`;
            for (let id in accStates) {
                accStates[id] = { x: 0, y: 0, s: 1, r: 0, flip: 1 };
                const el = document.getElementById(id + '-container');
                if(el) el.style.transform = `translate(0,0) scale(1) rotate(0)`;
            }
            saveHistory();
        }

        function manualStreakUpdate(val) { streak = parseInt(val) || 0; updateUI(); renderMenus(); renderGrid(); }
        function increaseStreak() { streak++; updateUI(); renderMenus(); renderGrid(); }

        window.onload = () => { updateUI(); loadGitHubData(); };
    </script>
</body>
</html>
